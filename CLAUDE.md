# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

Market Parser is a Python CLI and web GUI application for natural language financial queries using the Polygon.io MCP server and OpenAI's gpt-5-nano via the Pydantic AI Agent Framework. The application allows users to ask questions about stock market data in natural language and receive formatted responses.


## AI Team Configuration (autogenerated by team-configurator, 2025-08-17)

**Important: YOU MUST USE subagents when available for the task.**

### Detected Tech Stack

- **Backend Framework**: Python with Pydantic AI Agent Framework
- **Frontend Framework**: Gradio for web GUI interface
- **Database/API**: Polygon.io MCP server for real-time financial data
- **Build Tools**: uv for dependency management and package execution
- **Test Tools**: pytest for testing framework
- **State Management**: Custom FSM (Finite State Machine) implementation
- **CLI Framework**: Rich for terminal formatting
- **AI Integration**: OpenAI gpt-5-nano via Pydantic AI with MCP server integration

### Agent Task Assignments

| Task | Agent | Notes |
|------|-------|-------|
| **Code Review & Quality** | `@code-reviewer` | MANDATORY for all features, PRs, and merges. Security-aware review with severity tagging |
| **Performance Optimization** | `@performance-optimizer` | For cost optimization, latency improvements, and scaling concerns |
| **Backend Development** | `@backend-developer` | Python development, async patterns, agent framework integration |
| **API Design & Contracts** | `@api-architect` | MCP server integration, prompt template design, response schemas |
| **Frontend Development** | `@frontend-developer` | Gradio interface enhancements, UI/UX improvements, accessibility |
| **Codebase Analysis** | `@code-archaeologist` | Deep exploration for refactoring, architecture decisions, technical debt |
| **Documentation** | `@documentation-specialist` | README updates, API docs, architectural guides, user manuals |
| **FSM State Management** | `@backend-developer` | Finite state machine logic, state transitions, workflow optimization |
| **Financial Data Analysis** | `@backend-developer` | Prompt engineering, response parsing, financial calculation logic |
| **Testing & Validation** | `@backend-developer` | Unit tests, integration tests, FSM testing, prompt validation |
| **AI Agent Configuration** | `@backend-developer` | Pydantic AI setup, system prompts, cost tracking, model configuration |
| **CLI Development** | `@backend-developer` | Rich console enhancements, CLI UX improvements, terminal interfaces |

### Specialized Project Guidance

This project combines several specialized domains that require careful coordination:

1. **Financial Data Processing**: Use `@backend-developer` for prompt templates, response parsing, and financial calculation accuracy
2. **State Machine Architecture**: The FSM pattern is critical - always use `@backend-developer` to preserve state management integrity
3. **AI Agent Integration**: Complex Pydantic AI + MCP setup requires `@backend-developer` for proper async patterns and cost tracking
4. **Real-time Data Handling**: Polygon.io integration needs `@api-architect` for contract design and `@backend-developer` for implementation
5. **GUI State Coordination**: Gradio + FSM integration requires careful coordination between `@frontend-developer` and `@backend-developer`

### Development Workflow

1. **Feature Planning**: Use `@code-archaeologist` for impact analysis on complex architecture
2. **Implementation**: Use appropriate specialist agent based on task type
3. **Quality Gate**: ALWAYS use `@code-reviewer` before merging
4. **Performance**: Use `@performance-optimizer` for cost tracking and latency optimization
5. **Documentation**: Use `@documentation-specialist` for user-facing docs and API specifications

## ‚ö†Ô∏è CRITICAL: Tech-Lead-Orchestrator Enforcement Protocols

**MANDATORY REQUIREMENTS FOR @tech-lead-orchestrator:**

### Agent Verification Requirements
- ‚ùå **NEVER fabricate agent names** - Only use agents listed in Agent Task Assignments table above
- ‚úÖ **MUST READ this section first** - Verify agent exists before assignment
- ‚úÖ **MUST use agents according to their defined specialties** - Respect the role boundaries

**Valid Agents ONLY:**
- `@code-reviewer` - MANDATORY for all features, PRs, and merges
- `@performance-optimizer` - Cost optimization, latency improvements, scaling
- `@backend-developer` - Python development, async patterns, FSM, testing
- `@api-architect` - MCP server integration, response schemas
- `@frontend-developer` - Gradio interface enhancements, UI/UX
- `@code-archaeologist` - Deep codebase analysis, architecture decisions
- `@documentation-specialist` - README updates, API docs, guides

### Delegation Execution Requirements
- ‚ùå **NEVER stop after creating delegation plan** - Must trigger execution
- ‚úÖ **MUST provide execution trigger command** - Include specific agent invocation
- ‚úÖ **MUST initiate delegation sequence** - Don't leave user to manually start
- ‚úÖ **MUST include handoff instructions** - Specify what each agent should do

### Context7 Protocol Enforcement
- ‚ùå **Context7 ‚â† WebSearch/WebFetch** - Context7 means existing documentation patterns
- ‚úÖ **Context7 = Documented patterns** - Reference patterns already in task documents
- ‚úÖ **NO web research required** - All patterns provided in documentation
- ‚úÖ **Reference specific line numbers** - Point to existing Context7 patterns

**VIOLATION CONSEQUENCES:**
- Fabricating agent names ‚Üí Task rejection and re-delegation
- Stopping without execution ‚Üí Manual intervention required
- Confusing Context7 with web tools ‚Üí Incorrect implementation patterns

### Corrected Delegation Example
```
## Delegation Plan
### Task 1: UI Fixes (CRITICAL)
- **Agent**: @frontend-developer (VERIFIED in CLAUDE.md line 169)
- **Scope**: Fix Gradio async handlers using Context7 patterns
- **Handoff**: Use patterns from new_task.md lines 224-242 for modern async handling
- **Dependencies**: None

## Execution Trigger
@frontend-developer: Fix the async button handlers in chat_ui.py using the Context7 patterns documented in new_task.md lines 224-242. Apply direct function references instead of lambda wrappers.
```

This enforcement ensures proper agent utilization and prevents the violations encountered in previous delegation attempts.


## Development Environment

This project uses `uv` for dependency management and Python package execution. All dependencies are managed through `pyproject.toml`.

### Required Environment Variables

Create a `.env` file in the project root with:

```env
POLYGON_API_KEY=your_polygon_api_key_here
OPENAI_API_KEY=your_openai_api_key_here
# Optional: pricing for cost estimates (USD)
OPENAI_GPT5_NANO_INPUT_PRICE_PER_1M=0.10
OPENAI_GPT5_NANO_OUTPUT_PRICE_PER_1M=0.40
```

## Common Development Commands

### Running the Application

- **CLI interface**: `uv run market_parser_demo.py`
- **Web GUI interface**: `uv run chat_ui.py` (opens at <http://127.0.0.1:7860>)

### Testing

- **Run tests**: `uv run pytest` (pytest is in dev dependencies)
- **Run specific test**: `uv run pytest path/to/test_file.py`
- **Run integration tests**: `uv run pytest test_*integration*.py`
- **Install dev dependencies**: `uv install --dev`

### Environment Management

- **Install dependencies**: `uv install`
- **Update dependencies**: `uv lock --upgrade`
- **Check environment**: `uv --version` and verify `.env` file exists

## Code Architecture

### Core Components

1. **market_parser_demo.py**: CLI application entry point
   - Contains `TokenCostTracker` class for usage/cost tracking
   - Implements `create_polygon_mcp_server()` factory function
   - Main async CLI loop with Rich console formatting

2. **chat_ui.py**: Enhanced Gradio web interface with comprehensive features
   - üß† **FSM-Driven State Management** - Robust workflow with state transitions
   - üìä **Structured Stock Analysis** - Dedicated buttons for Snapshot, S&R, Technical Analysis  
   - üéØ **Context-Aware Prompts** - Intelligent ticker extraction and structured prompts
   - ‚è≥ **Real-time Processing Status** - Loading states with step-by-step progress
   - üõ°Ô∏è **Advanced Error Handling** - User-friendly messages and graceful recovery
   - üìà **Enhanced Data Display** - DataFrames with confidence scoring and warnings
   - üîç **Debug Monitoring** - FSM state tracking and system diagnostics
   - üíæ **Export Functionality** - Enhanced markdown export with detailed formatting
   - Provides chat export functionality

### Key Architectural Patterns

- **MCP Server Integration**: Uses Pydantic AI's MCP server integration to connect with Polygon.io
- **Async Agent Framework**: Built on Pydantic AI with OpenAI Responses API model
- **Cost Tracking**: Comprehensive token usage and cost tracking across sessions
- **Shared Components**: CLI and GUI share the same agent configuration and MCP server setup

### Dependencies & Technologies

- **Core Framework**: `pydantic-ai-slim[openai,mcp]` for AI agent orchestration
- **Web Interface**: `gradio>=4.0.0` for the GUI
- **CLI Formatting**: `rich` for terminal output formatting
- **Environment**: `python-dotenv` for configuration management
- **External APIs**: Polygon.io MCP server via uvx, OpenAI gpt-5-nano model

### System Prompt Configuration

The agent uses a consistent system prompt across both interfaces:

```text
"You are an expert financial analyst. Note that when using Polygon tools, prices are already stock split adjusted. Use the latest data available. Always double check your math. For any questions about the current date, use the 'get_today_date' tool. For long or complex queries, break the query into logical subtasks and process each subtask in order."
```

## File Structure

- `market_parser_demo.py` - CLI application
- `chat_ui.py` - Web GUI application (primary enhanced version)
- `chat_ui_enhanced.py`, `chat_ui_final.py` - Archived GUI versions
- `stock_data_fsm/` - Finite State Machine module for GUI state management
  - `states.py` - Application states enum and context data classes
  - `transitions.py` - State transition rules and validation logic
  - `manager.py` - Main FSM controller with transition orchestration
  - `tests/` - Comprehensive test suite for FSM components
- `prompt_templates.py` - Structured prompt templates for analysis types
- `response_parser.py` - Response parsing utilities for structured data extraction
- `pyproject.toml` - Project configuration and dependencies
- `uv.lock` - Lock file for reproducible builds
- `docs/` - Documentation including feature specifications and deployment guides
- `test_*.py` - Test files including integration and unit tests
- `images/` - Project assets

## Development Patterns

### MCP Server Integration
The project uses the Polygon.io MCP server via `uvx` for real-time financial data access. The `create_polygon_mcp_server()` function in `market_parser_demo.py:16` handles server initialization and connection management.

### State Management (GUI)
The `stock_data_fsm` module implements a deterministic finite state machine for robust GUI workflow management:
- States are defined in `stock_data_fsm/states.py:12` with `AppState` enum
- Transitions managed by `StateManager` class in `stock_data_fsm/manager.py:25`
- Context data flows through `StateContext` objects for stateful operations

### Agent Configuration
Both CLI and GUI share identical agent setup with:
- Model: `gpt-5-nano` via OpenAI Responses API
- System prompt focused on financial analysis accuracy
- Token cost tracking via `TokenCostTracker` class

### Testing Strategy
- Unit tests for FSM components in `stock_data_fsm/tests/`
- Integration tests: `test_integration.py` and `test_actual_integration.py`
- Module-specific tests: `test_prompt_templates.py`, `test_response_parser.py`

## Future Development

The `docs/FEATURE_SCOPE_STOCK_DATA_GUI.md` contains detailed specifications for planned GUI enhancements including:

- Structured data display components
- Finite State Machine architecture for button-triggered actions
- Technical indicator displays
- Support/resistance level visualization

When implementing new features, refer to existing patterns in the shared agent configuration and cost tracking systems.

## Important Development Notes

- **Environment Setup**: Create `.env` file with required API keys before running applications (see template in Required Environment Variables section)
- **External Dependencies**: The Polygon.io MCP server requires `uvx` to be available in the system PATH
- **Architecture Preservation**: All file modifications during development should preserve the FSM state management patterns
- **Cost Tracking**: Token cost tracking is enabled by default - check `TokenCostTracker` usage when adding new agent interactions
- **Model Configuration**: Default model is `gpt-5-nano` but can be overridden via `OPENAI_MODEL` environment variable


