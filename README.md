# Market Parser with Polygon MCP Server

![Project Logo](images/logo.png)

A Python CLI and web GUI application for natural language financial queries using the [Polygon.io](https://polygon.io/) [MCP server](https://github.com/polygon-io/mcp_polygon) and OpenAI `gpt-5-nano` via the [Pydantic AI Agent Framework](https://ai.pydantic.dev/agents/).

## Features

- **Ask questions like:**
  - `Tesla price now`
  - `AAPL volume last week`
  - `Show me the price of MSFT on 2023-01-01`

- **Rich CLI output:**
  Answers are formatted for easy reading in your terminal.

- **Enhanced Web Interface:**
  - 🎯 **Enhanced JSON Architecture** - Comprehensive schema-driven system with validation
  - 📊 **Three Analysis Types** - Stock Snapshot, Support & Resistance, Technical Analysis
  - 🔄 **5-State Workflow** - Reliable, predictable user interactions
  - ⏳ **Real-time Loading States** - Step-by-step progress feedback
  - 🛡️ **Advanced Error Recovery** - Non-blocking error recovery with immediate retry
  - 🔍 **Comprehensive Monitoring** - Enhanced debug logging and performance tracking
  - 🎨 **Enhanced Data Display** - Real-time JSON textboxes with confidence indicators

## Disclaimer

**Warning:** The examples, demos, and outputs produced with this project are generated by artificial intelligence and large language models. You acknowledge that this project and any outputs are provided "AS IS", may not always be accurate and may contain material inaccuracies even if they appear accurate because of their level of detail or specificity, outputs may not be error free, accurate, current, complete, or operate as you intended, you should not rely on any outputs or actions without independently confirming their accuracy, and any outputs should not be treated as financial or legal advice. You remain responsible for verifying the accuracy, suitability, and legality of any output before relying on it.

---

## Quickstart (with [uv](https://github.com/astral-sh/uv))

1. **Install [uv](https://github.com/astral-sh/uv) if you don't have it:**

   ```sh
   curl -Ls https://astral.sh/uv/install.sh | sh
   ```

2. **Get your API keys:**
   - [Polygon.io API key](https://polygon.io/)
   - [OpenAI API key](https://platform.openai.com/)

3. **Create a `.env` at the project root (recommended):**

   ```env
   POLYGON_API_KEY=your_polygon_api_key_here
   OPENAI_API_KEY=your_openai_api_key_here
   # Optional: pricing for cost estimates (USD)
   OPENAI_GPT5_NANO_INPUT_PRICE_PER_1M=0.10
   OPENAI_GPT5_NANO_OUTPUT_PRICE_PER_1M=0.40
   ```

4. **Run the CLI (dependencies will be auto-installed from `pyproject.toml`):**

   ```sh
   uv run market_parser_demo.py
   ```

5. **Type your question and press Enter!**

   Type `exit` to quit.

---

## Enhanced Web GUI

You can also use a web-based GUI (Gradio) that provides structured analysis tools with enhanced JSON architecture.

- Run the GUI:

  ```sh
  uv run chat_ui.py
  ```
  
  **Features Available in Enhanced Web UI:**
  - 🧠 **5-State FSM Workflow** - Enhanced state management (IDLE → BUTTON_TRIGGERED → AI_PROCESSING → RESPONSE_RECEIVED → ERROR)
  - 📊 **Three Analysis Buttons** - Stock Snapshot, Support & Resistance, Technical Analysis
  - 🎯 **Smart Ticker Detection** - Automatic extraction from conversation context
  - 📝 **Enhanced JSON Outputs** - Comprehensive schema-driven system with validation
  - ⏳ **Real-time Loading States** - Step-by-step progress feedback during analysis
  - 🛡️ **Advanced Error Recovery** - Non-blocking error recovery with immediate button retry
  - 🔍 **Comprehensive Monitoring** - Debug logging and performance tracking
  - 🎨 **Enhanced Data Display** - Real-time JSON textboxes with confidence indicators

- The app will print a local URL (default `http://127.0.0.1:7860`) to open in your browser.
- Pricing env vars (set in `.env`) will be used for cost estimates just like the CLI.

Environment variables:

- `OPENAI_MODEL` (optional, default `gpt-5-nano`)
- `HOST` and `PORT` to override GUI host/port

---

## Enhanced Architecture Benefits

### Why We Enhanced

The system was optimized in 2025 to focus on **reliability with enhanced capabilities**:

- **Enhanced JSON Architecture**: Comprehensive schema-driven system with validation and fallback strategies
- **Dual Parser System**: JSON primary with regex fallback for maximum compatibility
- **Advanced Monitoring**: Comprehensive debug logging with performance tracking
- **Cost Optimization**: Enhanced resource usage monitoring and optimization
- **Team Coordination**: Optimized AI team with primary architects and secondary support

### Enhanced Architecture Features

**Enhanced JSON System:**
- Comprehensive schema validation with JSON Schema Draft 2020-12 compliance
- Dual parser architecture (JSON + regex fallback) for reliability
- Confidence scoring and auto-correction capabilities
- Multi-layer validation with business rules

**5-State FSM with JSON Integration:**
- IDLE → BUTTON_TRIGGERED → AI_PROCESSING → RESPONSE_RECEIVED → ERROR
- JSON-aware state transitions with validation integration
- Non-blocking error recovery with immediate button retry

**Advanced Monitoring & Debug:**
- Comprehensive JSON workflow logging with unique identifiers
- Performance metrics for optimization insights
- Error analysis with context preservation
- Advanced debug logging for production troubleshooting

---

## Pricing and Cost Estimates

Set these optional env vars to compute accurate cost estimates (USD per 1M tokens):

```env
# Example values below — update with current OpenAI pricing for gpt-5-nano
OPENAI_GPT5_NANO_INPUT_PRICE_PER_1M=0.10
OPENAI_GPT5_NANO_OUTPUT_PRICE_PER_1M=0.40
```

At the end of each request, the CLI prints:

- Per message: input tokens, output tokens, input cost, output cost
- Session cumulative totals across the current run

Example snippet:

```text
Per Message Usage & Cost:
  - Input tokens: 1,234 | Input cost: $0.000123
  - Output tokens: 2,345 | Output cost: $0.000938
  - Message total cost: $0.001061

Session Total (Cumulative):
  - Total input tokens: 8,765 | Total input cost: $0.000877
  - Total output tokens: 9,876 | Total output cost: $0.003950
  - Session total cost: $0.004827
```

---

## Example Usage

```text
> Tesla price now
✔ Query processed successfully!
Agent Response:
$TSLA is currently trading at $XXX.XX (as of 2024-06-07 15:30:00 UTC).
---------------------

> exit
Goodbye!
```

For reference, this is the system prompt used with every query:

```text
system_prompt=(
    "You are an expert financial analyst. Note that when using Polygon tools, prices are already stock split adjusted. "
    "Use the latest data available. Always double check your math. "
    "For any questions about the current date, use the 'get_today_date' tool. "
    "For long or complex queries, break the query into logical subtasks and process each subtask in order."
)
```

Be specific in your prompt. The better the prompt - the better the response.

---

## Enhanced Project Structure

The project has been organized for maximum maintainability with enhanced JSON architecture:

```
market-parser-polygon-mcp/
├── src/                          # Core application modules
│   ├── response_parser.py        # Response parsing with get_json_output() method
│   ├── json_parser.py           # Dual parser architecture (JSON + regex fallback)
│   ├── json_schemas.py          # JSON Schema Draft 2020-12 compliant definitions
│   ├── prompt_templates.py      # Templates for three analysis types
│   ├── schema_validator.py      # Multi-layer validation with business rules
│   ├── json_debug_logger.py     # Comprehensive JSON workflow logging
│   ├── security_utils.py        # Input validation and security
│   └── example_json_responses.py # Test examples
├── stock_data_fsm/              # Enhanced 5-State FSM
│   ├── states.py                # 5 states: IDLE, BUTTON_TRIGGERED, AI_PROCESSING, RESPONSE_RECEIVED, ERROR
│   ├── transitions.py           # JSON-aware transition rules
│   ├── manager.py               # FSM controller with JSON validation integration
│   └── tests/                   # FSM-specific test suite (comprehensive coverage)
├── tests/                       # Comprehensive test suite
│   ├── test_integration.py      # Integration tests (updated for enhanced architecture)
│   ├── test_simplified_fsm_workflow.py # 5-state workflow validation
│   ├── test_response_parser.py  # JSON output validation with dual parser testing
│   ├── test_json_schemas.py     # Schema validation testing
│   ├── run_*.py                 # Test runners and scripts
│   └── validate_*.py            # Fix validation scripts
├── logs/                        # Application and debug logs
├── docs/                        # Enhanced documentation
│   ├── JSON_ARCHITECTURE_GUIDE.md # Comprehensive JSON system guide
│   ├── USER_GUIDE_JSON_FEATURES.md # Enhanced feature documentation
│   ├── reports/                 # Technical reports
│   ├── SYSTEM_SIMPLIFICATION_GUIDE.md # Migration documentation
│   └── *.md                     # Enhanced architecture guides
├── market_parser_demo.py        # CLI application entry point
├── chat_ui.py                   # Enhanced web GUI with JSON architecture
└── pyproject.toml              # Project configuration
```

**Key Benefits of Enhanced Structure:**
- **Reliability**: Enhanced JSON architecture with comprehensive validation
- **Performance**: Dual parser system with fallback strategies for maximum compatibility
- **Monitoring**: Advanced debug logging and performance tracking
- **Maintainability**: Enhanced components with clear separation of concerns
- **Testing**: Comprehensive test coverage with enhanced architecture validation
- **Team Coordination**: Optimized AI team structure with primary architects

---

## Troubleshooting

- **Missing API Key:**

  If you see an error about `POLYGON_API_KEY` or `OPENAI_API_KEY`, make sure your `.env` file is in the project root.

- **Dependencies:**

  If you get `ModuleNotFoundError`, make sure your `pyproject.toml` lists:
  - `python-dotenv`
  - `rich`
  - `pydantic-ai-slim[openai]`
  - `gradio`

  If you prefer, you can use pip instead:

  ```sh
  pip install python-dotenv rich "pydantic-ai-slim[openai]" gradio
  python market_parser_demo.py
  ```

- **Import Errors with Enhanced Structure:**

  With the enhanced structure, update imports to use the new patterns:
  ```python
  # Enhanced import patterns:
  from src.response_parser import ResponseParser
  from src.prompt_templates import PromptTemplateManager
  from src.json_schemas import StockDataSchema
  from src.schema_validator import SchemaValidator
  from stock_data_fsm.states import AppState, StateContext
  ```

- **Test Execution:**

  Run tests from the project root using the enhanced structure:
  ```sh
  # All tests (comprehensive coverage)
  uv run pytest tests/
  
  # Specific test files
  uv run pytest tests/test_integration.py
  
  # Enhanced FSM workflow tests
  uv run pytest tests/test_simplified_fsm_workflow.py
  
  # JSON architecture validation
  uv run pytest tests/test_json_schemas.py
  ```

- **JSON Output Issues:**

  The enhanced system uses comprehensive JSON validation:
  - Check the "Raw JSON Response" sections in the web UI
  - Use `response_parser.get_json_output()` method in code
  - Export JSON for external analysis tools
  - Review confidence scoring and validation results

- **UI Stuck in Loading State:**

  With the enhanced 5-state FSM:
  - Click any analysis button to trigger immediate recovery
  - System automatically returns to IDLE state after errors
  - No system restart required for error recovery
  - Check debug logs for comprehensive error analysis

- **Performance Issues:**

  Enhanced architecture includes performance optimization:
  - Monitor JSON processing efficiency metrics
  - Review validation caching effectiveness
  - Check resource usage optimization
  - Analyze comprehensive debug logs for bottlenecks

- **Incorrect Responses**

  AI Data can be incorrect. Like all LLM generated responses, please double check.

- **Other errors:**

  All errors are printed in red in the terminal for easy debugging.

---

## Enhanced Development Workflow

### Running the Application

- **CLI interface**: `uv run market_parser_demo.py`
- **Web GUI interface**: `uv run chat_ui.py` (opens at <http://127.0.0.1:7860>)

### Testing

- **Run all tests**: `uv run pytest tests/` (comprehensive coverage with enhanced architecture)
- **Run specific test**: `uv run pytest tests/test_file.py`
- **Run enhanced FSM tests**: `uv run pytest tests/test_simplified_fsm_workflow.py`
- **Validate enhanced architecture**: `uv run python tests/validate_simplified_test_suite.py`
- **JSON schema validation**: `uv run pytest tests/test_json_schemas.py`

### Environment Management

- **Install dependencies**: `uv install`
- **Update dependencies**: `uv lock --upgrade`
- **Check environment**: `uv --version` and verify `.env` file exists

---

## How it Works (Enhanced Architecture)

- Loads your Polygon and OpenAI API keys from `.env`
- Starts the Polygon MCP server in the background
- Uses enhanced 5-state FSM for reliable workflow management
- Sends your natural language query to OpenAI `gpt-5-nano` via PydanticAI
- Returns structured JSON responses with comprehensive validation
- Provides non-blocking error recovery for uninterrupted usage
- Monitors performance with advanced debug logging

### The Enhanced 5-State Workflow

1. **IDLE**: Ready for user input
2. **BUTTON_TRIGGERED**: User clicked an analysis button
3. **AI_PROCESSING**: Waiting for AI response with JSON validation
4. **RESPONSE_RECEIVED**: Display validated JSON results with confidence scoring
5. **ERROR**: Non-blocking error state with immediate recovery and detailed logging

### Enhanced JSON Architecture

- **Schema-Driven System**: JSON Schema Draft 2020-12 compliant with versioning
- **Dual Parser Architecture**: Primary JSON parser with regex fallback
- **Comprehensive Validation**: Multi-layer validation with business rules
- **Performance Optimization**: Validation caching and resource monitoring
- **Advanced Monitoring**: Comprehensive debug logging with workflow tracking

---

## Migration from Previous Version

If you're upgrading from the previous version, see:
- `docs/SYSTEM_SIMPLIFICATION_GUIDE.md` for detailed migration steps
- `docs/JSON_ARCHITECTURE_GUIDE.md` for enhanced JSON system documentation
- `docs/reports/PHASE_*` reports for technical implementation details
- `tests/PHASE_3_TEST_UPDATES_SUMMARY.md` for test architecture changes

---

## AI Team Structure

This project uses an optimized AI team configuration with:

- **Primary Architects**: `@backend-developer` leads JSON schema and FSM architecture
- **Quality Assurance**: `@code-reviewer` mandatory for all changes with FSM integrity focus
- **Performance Optimization**: `@performance-optimizer` for cost and resource optimization
- **UI Enhancement**: `@frontend-developer` for Gradio-specific JSON textbox optimization
- **Documentation**: `@documentation-specialist` for comprehensive system guides
- **Deep Analysis**: `@code-archaeologist` for complex architecture decisions when needed

---

## Local Path

- /mnt/d/Github/market-parser-polygon-mcp

## License

This project is licensed under the [MIT License](LICENSE).