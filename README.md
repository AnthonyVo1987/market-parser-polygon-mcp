# Market Parser with Polygon MCP Server

![Project Logo](images/logo.png)

A simplified Python CLI and web GUI application for natural language financial queries using the [Polygon.io](https://polygon.io/) [MCP server](https://github.com/polygon-io/mcp_polygon) and OpenAI `gpt-5-nano` via the [Pydantic AI Agent Framework](https://ai.pydantic.dev/agents/).

## Features

- **Ask questions like:**
  - `Tesla price now`
  - `AAPL volume last week`
  - `Show me the price of MSFT on 2023-01-01`

- **Rich CLI output:**
  Answers are formatted for easy reading in your terminal.

- **Simplified Web Interface:**
  - 🎯 **JSON-First Architecture** - Direct access to raw AI responses
  - 📊 **Three Analysis Types** - Stock Snapshot, Support & Resistance, Technical Analysis
  - 🔄 **5-State Workflow** - Simple, predictable user interactions
  - ⏳ **Real-time Loading States** - Step-by-step progress feedback
  - 🛡️ **Non-blocking Error Recovery** - Immediate error recovery without UI freezing
  - 🔍 **Debug-Friendly** - Raw JSON outputs for transparency and export

## Disclaimer

**Warning:** The examples, demos, and outputs produced with this project are generated by artificial intelligence and large language models. You acknowledge that this project and any outputs are provided "AS IS", may not always be accurate and may contain material inaccuracies even if they appear accurate because of their level of detail or specificity, outputs may not be error free, accurate, current, complete, or operate as you intended, you should not rely on any outputs or actions without independently confirming their accuracy, and any outputs should not be treated as financial or legal advice. You remain responsible for verifying the accuracy, suitability, and legality of any output before relying on it.

---

## Quickstart (with [uv](https://github.com/astral-sh/uv))

1. **Install [uv](https://github.com/astral-sh/uv) if you don't have it:**

   ```sh
   curl -Ls https://astral.sh/uv/install.sh | sh
   ```

2. **Get your API keys:**
   - [Polygon.io API key](https://polygon.io/)
   - [OpenAI API key](https://platform.openai.com/)

3. **Create a `.env` at the project root (recommended):**

   ```env
   POLYGON_API_KEY=your_polygon_api_key_here
   OPENAI_API_KEY=your_openai_api_key_here
   # Optional: pricing for cost estimates (USD)
   OPENAI_GPT5_NANO_INPUT_PRICE_PER_1M=0.10
   OPENAI_GPT5_NANO_OUTPUT_PRICE_PER_1M=0.40
   ```

4. **Run the CLI (dependencies will be auto-installed from `pyproject.toml`):**

   ```sh
   uv run market_parser_demo.py
   ```

5. **Type your question and press Enter!**

   Type `exit` to quit.

---

## Simplified Web GUI

You can also use a web-based GUI (Gradio) that provides structured analysis tools with JSON-only outputs.

- Run the GUI:

  ```sh
  uv run chat_ui.py
  ```
  
  **Features Available in Simplified Web UI:**
  - 🧠 **5-State FSM Workflow** - Simplified state management (IDLE → BUTTON_TRIGGERED → AI_PROCESSING → RESPONSE_RECEIVED → ERROR)
  - 📊 **Three Analysis Buttons** - Stock Snapshot, Support & Resistance, Technical Analysis
  - 🎯 **Smart Ticker Detection** - Automatic extraction from conversation context
  - 📝 **Raw JSON Outputs** - Direct access to structured AI responses
  - ⏳ **Real-time Loading States** - Step-by-step progress feedback during analysis
  - 🛡️ **Non-blocking Error Recovery** - Immediate error recovery with button retry
  - 🔍 **Debug Transparency** - Complete JSON responses for export and analysis

- The app will print a local URL (default `http://127.0.0.1:7860`) to open in your browser.
- Pricing env vars (set in `.env`) will be used for cost estimates just like the CLI.

Environment variables:

- `OPENAI_MODEL` (optional, default `gpt-4o-mini`)
- `HOST` and `PORT` to override GUI host/port

---

## Simplified Architecture Benefits

### Why We Simplified

The system was redesigned in 2025 to focus on **reliability over complexity**:

- **JSON-First Approach**: Raw AI responses provide maximum transparency and flexibility
- **Reduced State Complexity**: 5-state FSM instead of 12+ states for predictable behavior
- **Non-blocking Errors**: Users can immediately retry without system restart
- **Future-Ready**: Simplified architecture supports easy migration to React/Next.js
- **Debugging**: Raw JSON outputs make troubleshooting straightforward

### What Changed

**Before (Complex):**
- 12+ FSM states with complex transitions
- Structured DataFrame displays with parsing dependencies
- Blocking error states requiring system restart

**After (Simplified):**
- 5 clear states: IDLE → BUTTON_TRIGGERED → AI_PROCESSING → RESPONSE_RECEIVED → ERROR
- Raw JSON textboxes for all outputs
- Immediate error recovery with button retry

---

## Pricing and Cost Estimates

Set these optional env vars to compute accurate cost estimates (USD per 1M tokens):

```env
# Example values below — update with current OpenAI pricing for gpt-4o-mini
OPENAI_GPT5_NANO_INPUT_PRICE_PER_1M=0.10
OPENAI_GPT5_NANO_OUTPUT_PRICE_PER_1M=0.40
```

At the end of each request, the CLI prints:

- Per message: input tokens, output tokens, input cost, output cost
- Session cumulative totals across the current run

Example snippet:

```text
Per Message Usage & Cost:
  - Input tokens: 1,234 | Input cost: $0.000123
  - Output tokens: 2,345 | Output cost: $0.000938
  - Message total cost: $0.001061

Session Total (Cumulative):
  - Total input tokens: 8,765 | Total input cost: $0.000877
  - Total output tokens: 9,876 | Total output cost: $0.003950
  - Session total cost: $0.004827
```

---

## Example Usage

```text
> Tesla price now
✔ Query processed successfully!
Agent Response:
$TSLA is currently trading at $XXX.XX (as of 2024-06-07 15:30:00 UTC).
---------------------

> exit
Goodbye!
```

For reference, this is the system prompt used with every query:

```text
system_prompt=(
    "You are an expert financial analyst. Note that when using Polygon tools, prices are already stock split adjusted. "
    "Use the latest data available. Always double check your math. "
    "For any questions about the current date, use the 'get_today_date' tool. "
    "For long or complex queries, break the query into logical subtasks and process each subtask in order."
)
```

Be specific in your prompt. The better the prompt - the better the response.

---

## Simplified Project Structure

The project has been organized for maximum maintainability:

```
market-parser-polygon-mcp/
├── src/                          # Core application modules
│   ├── response_parser.py        # Response parsing with get_json_output() method
│   ├── json_parser.py           # JSON parsing with fallback strategies
│   ├── json_schemas.py          # Schema definitions (simplified)
│   ├── prompt_templates.py      # Templates for three analysis types
│   ├── schema_validator.py      # Basic validation logic
│   ├── json_debug_logger.py     # Debug logging for workflows
│   ├── security_utils.py        # Input validation and security
│   └── example_json_responses.py # Test examples
├── stock_data_fsm/              # Simplified 5-State FSM
│   ├── states.py                # 5 states: IDLE, BUTTON_TRIGGERED, AI_PROCESSING, RESPONSE_RECEIVED, ERROR
│   ├── transitions.py           # Simplified transition rules
│   ├── manager.py               # FSM controller with non-blocking error recovery
│   └── tests/                   # FSM-specific test suite (80/80 tests passing)
├── tests/                       # Comprehensive test suite
│   ├── test_integration.py      # Integration tests (updated for simplified architecture)
│   ├── test_simplified_fsm_workflow.py # 5-state workflow validation
│   ├── test_response_parser.py  # JSON output validation (29/29 tests passing)
│   ├── run_*.py                 # Test runners and scripts
│   └── validate_*.py            # Fix validation scripts
├── logs/                        # Application and debug logs
├── docs/                        # Updated documentation
│   ├── reports/                 # Technical reports
│   ├── SYSTEM_SIMPLIFICATION_GUIDE.md # Migration documentation
│   └── *.md                     # Updated architecture guides
├── market_parser_demo.py        # CLI application entry point
├── chat_ui.py                   # Simplified web GUI (JSON outputs only)
└── pyproject.toml              # Project configuration
```

**Key Benefits of Simplified Structure:**
- **Reliability**: 5-state FSM eliminates complex transition bugs
- **Transparency**: Raw JSON outputs provide full data access
- **Maintainability**: Simplified components reduce technical debt
- **Testing**: 100% test success rate with simplified architecture
- **Future-Ready**: Easy migration to modern frontend frameworks

---

## Troubleshooting

- **Missing API Key:**

  If you see an error about `POLYGON_API_KEY` or `OPENAI_API_KEY`, make sure your `.env` file is in the project root.

- **Dependencies:**

  If you get `ModuleNotFoundError`, make sure your `pyproject.toml` lists:
  - `python-dotenv`
  - `rich`
  - `pydantic-ai-slim[openai]`
  - `gradio`

  If you prefer, you can use pip instead:

  ```sh
  pip install python-dotenv rich "pydantic-ai-slim[openai]" gradio
  python market_parser_demo.py
  ```

- **Import Errors with Simplified Structure:**

  With the simplified structure, update imports to use the new patterns:
  ```python
  # Simplified import patterns:
  from src.response_parser import ResponseParser
  from src.prompt_templates import PromptTemplateManager
  from stock_data_fsm.states import AppState, StateContext
  ```

- **Test Execution:**

  Run tests from the project root using the simplified structure:
  ```sh
  # All tests (80/80 tests passing)
  uv run pytest tests/
  
  # Specific test files
  uv run pytest tests/test_integration.py
  
  # Simplified FSM workflow tests
  uv run pytest tests/test_simplified_fsm_workflow.py
  ```

- **JSON Output Issues:**

  The simplified system uses raw JSON outputs. If you need structured data:
  - Check the "Raw JSON Response" sections in the web UI
  - Use `response_parser.get_json_output()` method in code
  - Export JSON for external analysis tools

- **UI Stuck in Loading State:**

  With the simplified 5-state FSM:
  - Click any analysis button to trigger immediate recovery
  - System automatically returns to IDLE state after errors
  - No system restart required for error recovery

- **Incorrect Responses**

  AI Data can be incorrect. Like all LLM generated responses, please double check.

- **Other errors:**

  All errors are printed in red in the terminal for easy debugging.

---

## Simplified Development Workflow

### Running the Application

- **CLI interface**: `uv run market_parser_demo.py`
- **Web GUI interface**: `uv run chat_ui.py` (opens at <http://127.0.0.1:7860>)

### Testing

- **Run all tests**: `uv run pytest tests/` (80/80 tests passing with simplified architecture)
- **Run specific test**: `uv run pytest tests/test_file.py`
- **Run simplified FSM tests**: `uv run pytest tests/test_simplified_fsm_workflow.py`
- **Validate simplified architecture**: `uv run python tests/validate_simplified_test_suite.py`

### Environment Management

- **Install dependencies**: `uv install`
- **Update dependencies**: `uv lock --upgrade`
- **Check environment**: `uv --version` and verify `.env` file exists

---

## How it Works (Simplified)

- Loads your Polygon and OpenAI API keys from `.env`
- Starts the Polygon MCP server in the background
- Uses a simple 5-state FSM for reliable workflow management
- Sends your natural language query to OpenAI `gpt-4o-mini` via PydanticAI
- Returns raw JSON responses for maximum transparency and flexibility
- Provides non-blocking error recovery for uninterrupted usage

### The 5-State Workflow

1. **IDLE**: Ready for user input
2. **BUTTON_TRIGGERED**: User clicked an analysis button
3. **AI_PROCESSING**: Waiting for AI response
4. **RESPONSE_RECEIVED**: Display JSON results
5. **ERROR**: Non-blocking error state with immediate recovery

---

## Migration from Complex System

If you're upgrading from the previous complex version, see:
- `docs/SYSTEM_SIMPLIFICATION_GUIDE.md` for detailed migration steps
- `docs/reports/PHASE_*` reports for technical implementation details
- `tests/PHASE_3_TEST_UPDATES_SUMMARY.md` for test architecture changes

---

## Local Path

- /mnt/d/Github/market-parser-polygon-mcp

## License

This project is licensed under the [MIT License](LICENSE).