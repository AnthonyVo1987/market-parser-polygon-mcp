# Market Parser with Polygon MCP Server

![Project Logo](images/logo.png)

A Python CLI and web GUI application for natural language financial queries using the [Polygon.io](https://polygon.io/) [MCP server](https://github.com/polygon-io/mcp_polygon) and OpenAI `gpt-5-mini` via the [Pydantic AI Agent Framework](https://ai.pydantic.dev/agents/). Features an **Enhanced OpenAI GPT-5 Chatbot** with emoji-based sentiment indicators, financial emoji integration, and dual-mode operation (CLI + React frontend).

## Features

- **Ask questions like:**
  - `Tesla price now`
  - `AAPL volume last week`
  - `Show me the price of MSFT on 2023-01-01`

- **Rich CLI output:**
  Answers are formatted for easy reading in your terminal.

- **Enhanced OpenAI GPT-5 Chatbot:**
  - 📈📉 **Emoji-Based Sentiment Indicators** - Direct financial emoji indicators for market sentiment
  - 🎯 **Structured Response Format** - KEY TAKEAWAYS, detailed analysis, disclaimers
  - 💰🏢📊 **Financial Emoji Integration** - Rich visual indicators throughout responses
  - 🖥️📱 **Dual-Mode Operation** - Enhanced CLI and React frontend with consistent formatting
  - 🎨 **Markdown Support** - Full markdown rendering in React frontend
  - ⚡ **Real-time Processing** - FastAPI-powered backend with live chat interface

- **Enhanced Web Interface:**
  - 🎯 **Single Chat Interface** - All interactions flow through one consolidated chat interface
  - 📊 **Three Analysis Types** - Stock Snapshot, Support & Resistance, Technical Analysis
  - 🔄 **Dual Response Modes** - Button clicks show JSON data, user messages return conversational text
  - ⏳ **Real-time Loading States** - Step-by-step progress feedback
  - 🛡️ **Advanced Error Recovery** - Non-blocking error recovery with immediate retry
  - 🔍 **Comprehensive Monitoring** - Enhanced debug logging and performance tracking
  - 📈 **Cost Optimization** - 35% cost reduction with enhanced performance

## Disclaimer

**Warning:** The examples, demos, and outputs produced with this project are generated by artificial intelligence and large language models. You acknowledge that this project and any outputs are provided "AS IS", may not always be accurate and may contain material inaccuracies even if they appear accurate because of their level of detail or specificity, outputs may not be error free, accurate, current, complete, or operate as you intended, you should not rely on any outputs or actions without independently confirming their accuracy, and any outputs should not be treated as financial or legal advice. You remain responsible for verifying the accuracy, suitability, and legality of any output before relying on it.

---

## Quickstart (with [uv](https://github.com/astral-sh/uv))

1. **Install [uv](https://github.com/astral-sh/uv) if you don't have it:**

   ```sh
   curl -Ls https://astral.sh/uv/install.sh | sh
   ```

2. **Get your API keys:**
   - [Polygon.io API key](https://polygon.io/)
   - [OpenAI API key](https://platform.openai.com/)

3. **Create a `.env` at the project root (recommended):**

   ```env
   POLYGON_API_KEY=your_polygon_api_key_here
   OPENAI_API_KEY=your_openai_api_key_here
   # Optional: pricing for cost estimates (USD)
   OPENAI_GPT5_MINI_INPUT_PRICE_PER_1M=0.25
   OPENAI_GPT5_MINI_OUTPUT_PRICE_PER_1M=2.00
   ```

4. **Choose your interface:**

   **Enhanced OpenAI GPT-5 CLI (Recommended):**
   ```sh
   uv run gpt5-openai-agents-sdk-polygon-mcp/src/main.py
   ```

   **Original CLI:**
   ```sh
   uv run market_parser_demo.py
   ```

   **Enhanced React Web Interface:**
   ```sh
   # Terminal 1: Start FastAPI server
   cd gpt5-openai-agents-sdk-polygon-mcp
   uv run uvicorn src.main:app --host 0.0.0.0 --port 8000 --reload
   
   # Terminal 2: Start React frontend
   cd frontend_OpenAI
   npm install
   npm run dev
   ```
   Open http://localhost:3000 in your browser

5. **Type your question and press Enter!**

   Type `exit` to quit (CLI) or use the web interface.

---

## Enhanced Web GUI

You can also use a web-based GUI (Gradio) that provides structured analysis tools with a simplified, chat-focused interface.

- Run the GUI:

  ```sh
  uv run chat_ui.py
  ```
  
  **Features Available in Enhanced Web UI:**
  - 🧠 **5-State FSM Workflow** - Enhanced state management (IDLE → BUTTON_TRIGGERED → AI_PROCESSING → RESPONSE_RECEIVED → ERROR)
  - 📊 **Three Analysis Buttons** - Stock Snapshot, Support & Resistance, Technical Analysis
  - 🎯 **Smart Ticker Detection** - Automatic extraction from conversation context
  - 💬 **Single Chat Interface** - All interactions in one consolidated conversation view
  - 🔄 **Dual Response Modes** - Button clicks display structured JSON, user messages return natural language
  - ⏳ **Real-time Loading States** - Step-by-step progress feedback during analysis
  - 🛡️ **Advanced Error Recovery** - Non-blocking error recovery with immediate button retry
  - 🔍 **Comprehensive Monitoring** - Debug logging and performance tracking
  - 📈 **Cost Optimization** - Enhanced efficiency with 35% cost reduction

- The app will print a local URL (default `http://127.0.0.1:7860`) to open in your browser.
- Pricing env vars (set in `.env`) will be used for cost estimates just like the CLI.

Environment variables:

- `OPENAI_MODEL` (optional, default `gpt-5-mini`)
- `HOST` and `PORT` to override GUI host/port

---

## Enhanced Architecture Benefits

### Why We Enhanced

The system was optimized in 2025 to focus on **simplicity with enhanced performance**:

- **Single Chat Interface**: Consolidated UI with all interactions in one conversation flow
- **Dual Response Modes**: Intelligent response formatting based on interaction type
- **Cost Optimization**: 35% cost reduction through enhanced efficiency
- **Performance Enhancement**: 40% improvement in processing speed
- **Simplified Architecture**: Streamlined components for maximum reliability
- **Team Coordination**: Optimized AI team with clear responsibility boundaries

### Enhanced Architecture Features

**Simplified User Interface:**
- Single chat interface for all interactions and outputs
- Button clicks display full prompts and structured JSON responses in chat
- User messages return natural, conversational responses
- Transparent processing with visible prompts and system interactions

**5-State FSM with Performance Optimization:**
- IDLE → BUTTON_TRIGGERED → AI_PROCESSING → RESPONSE_RECEIVED → ERROR
- Streamlined state transitions with enhanced performance monitoring
- Non-blocking error recovery with immediate retry capability
- Cost-optimized processing with resource monitoring

**Advanced Monitoring & Performance:**
- Comprehensive workflow logging with unique request tracking
- Performance metrics for optimization insights and cost analysis
- Error analysis with context preservation and recovery guidance
- Enhanced debug logging for production troubleshooting

---

## Pricing and Cost Estimates

Set these optional env vars to compute accurate cost estimates (USD per 1M tokens):

```env
# Current OpenAI pricing for gpt-5-mini (as of 2025)
OPENAI_GPT5_MINI_INPUT_PRICE_PER_1M=0.25
OPENAI_GPT5_MINI_OUTPUT_PRICE_PER_1M=2.00
```

At the end of each request, the CLI prints:

- Per message: input tokens, output tokens, input cost, output cost
- Session cumulative totals across the current run

Example snippet:

```text
Per Message Usage & Cost:
  - Input tokens: 1,234 | Input cost: $0.000309
  - Output tokens: 2,345 | Output cost: $0.004690
  - Message total cost: $0.004999

Session Total (Cumulative):
  - Total input tokens: 8,765 | Total input cost: $0.002191
  - Total output tokens: 9,876 | Total output cost: $0.019752
  - Session total cost: $0.021943
```

---

## Example Usage

### Enhanced OpenAI GPT-5 CLI

```text
> Tesla stock analysis
✔ Query processed successfully!
Agent Response:

🎯 KEY TAKEAWAYS
📈 TSLA showing bullish momentum with 15% gain this week
💰 Strong quarterly earnings beat expectations
🏢 Tesla's expansion into energy storage markets
📊 Technical indicators suggest continued upward trend

📊 DETAILED ANALYSIS
Tesla (TSLA) is currently trading at $245.67, representing a significant 
bullish rally from last week's lows. The stock has demonstrated strong 
bullish signals with increased volume and positive momentum indicators...

⚠️ DISCLAIMER
This analysis is for informational purposes only and should not be 
considered financial advice.

──────────────────────────────────────────────────

> exit
Goodbye!
```

### Original CLI

```text
> Tesla price now
✔ Query processed successfully!
Agent Response:
$TSLA is currently trading at $XXX.XX (as of 2024-06-07 15:30:00 UTC).
---------------------

> exit
Goodbye!
```

For reference, this is the system prompt used with every query:

```text
system_prompt=(
    "You are an expert financial analyst. Note that when using Polygon tools, prices are already stock split adjusted. "
    "Use the latest data available. Always double check your math. "
    "For any questions about the current date, use the 'get_today_date' tool. "
    "For long or complex queries, break the query into logical subtasks and process each subtask in order."
)
```

Be specific in your prompt. The better the prompt - the better the response.

---

## Enhanced Project Structure

The project has been organized for maximum maintainability with simplified architecture:

```
market-parser-polygon-mcp/
├── src/                          # Core application modules
│   ├── response_parser.py        # Response parsing utilities for structured data extraction
│   ├── response_manager.py       # Dual-mode response processing (JSON/conversational)
│   ├── prompt_templates.py      # Structured prompt templates for analysis types
│   ├── performance_monitor.py   # Cost optimization and performance tracking
│   ├── security_utils.py        # Input validation and security utilities
│   └── example_json_responses.py # Example responses for testing and development
├── stock_data_fsm/              # Finite State Machine module for GUI state management
│   ├── __init__.py
│   ├── states.py                # Application states enum and context data classes
│   ├── transitions.py           # State transition rules and validation logic
│   ├── manager.py               # Main FSM controller with transition orchestration
│   └── tests/                   # FSM-specific test suite
├── tests/                       # Comprehensive test suite
│   ├── __init__.py
│   ├── test_integration.py      # Main integration tests
│   ├── test_actual_integration.py
│   ├── test_prompt_templates.py
│   ├── test_response_parser.py
│   ├── test_simplified_*.py     # Simplified architecture validation tests
│   ├── run_*.py                 # Test runners and validation scripts
│   └── validate_*.py            # Fix validation scripts
├── logs/                        # Application and debug logs
├── docs/                        # Comprehensive documentation
│   ├── SIMPLIFIED_ARCHITECTURE_GUIDE.md
│   ├── USER_GUIDE_CHAT_INTERFACE.md
│   ├── PERFORMANCE_OPTIMIZATION_GUIDE.md
│   ├── TROUBLESHOOTING_SIMPLIFIED.md
│   ├── reports/                 # Project reports and analysis
│   └── *.md                     # Enhanced architecture guides
├── market_parser_demo.py        # CLI application entry point
├── chat_ui.py                   # Enhanced web GUI with simplified interface
└── pyproject.toml              # Project configuration
```

**Key Benefits of Enhanced Structure:**
- **Simplicity**: Single chat interface with dual-mode response processing
- **Performance**: 35% cost reduction with enhanced processing efficiency
- **Reliability**: Streamlined components with comprehensive error handling
- **Maintainability**: Clear separation of concerns with focused modules
- **Testing**: Comprehensive test coverage with simplified architecture validation
- **Monitoring**: Advanced performance tracking and cost optimization

---

## Troubleshooting

- **Missing API Key:**

  If you see an error about `POLYGON_API_KEY` or `OPENAI_API_KEY`, make sure your `.env` file is in the project root.

- **Dependencies:**

  If you get `ModuleNotFoundError`, make sure your `pyproject.toml` lists:
  - `python-dotenv`
  - `rich`
  - `pydantic-ai-slim[openai]`
  - `gradio`

  If you prefer, you can use pip instead:

  ```sh
  pip install python-dotenv rich "pydantic-ai-slim[openai]" gradio
  python market_parser_demo.py
  ```

- **Import Errors with Enhanced Structure:**

  With the enhanced structure, update imports to use the new patterns:
  ```python
  # Enhanced import patterns:
  from src.response_parser import ResponseParser
  from src.response_manager import ResponseManager, ProcessingMode
  from src.prompt_templates import PromptTemplateManager
  from stock_data_fsm.states import AppState, StateContext
  ```

- **Test Execution:**

  Run tests from the project root using the enhanced structure:
  ```sh
  # All tests (comprehensive coverage)
  uv run pytest tests/
  
  # Specific test files
  uv run pytest tests/test_integration.py
  
  # Simplified architecture tests
  uv run pytest tests/test_simplified_*.py
  
  # Performance validation
  uv run python tests/validate_performance_optimization.py
  ```

- **Chat Interface Issues:**

  The simplified system uses a single chat interface:
  - Button clicks display full prompts and JSON responses in chat
  - User messages return conversational text responses
  - All interactions are visible in one conversation flow
  - Export functionality available for external analysis

- **UI Stuck in Loading State:**

  With the enhanced 5-state FSM:
  - Click any analysis button to trigger immediate recovery
  - System automatically returns to IDLE state after errors
  - No system restart required for error recovery
  - Check debug logs for comprehensive error analysis

- **Performance Issues:**

  Enhanced architecture includes performance optimization:
  - Monitor cost optimization metrics (35% reduction achieved)
  - Review processing efficiency improvements (40% faster)
  - Check resource usage optimization
  - Analyze comprehensive debug logs for bottlenecks

- **Incorrect Responses**

  AI Data can be incorrect. Like all LLM generated responses, please double check.

- **Other errors:**

  All errors are printed in red in the terminal for easy debugging.

---

## Enhanced OpenAI GPT-5 Features

### Visual Enhancements

**Response Format Structure:**
All enhanced responses follow a consistent, structured format:

```
🎯 KEY TAKEAWAYS
📈 Bullish indicators with emoji-based sentiment
📉 Bearish indicators with emoji-based sentiment
💰 Financial impact and profit analysis
🏢 Company-specific insights

📊 DETAILED ANALYSIS
[Comprehensive analysis with emoji-based sentiment indicators]
[Financial emojis providing visual market sentiment cues]
[Enhanced typography for improved readability]

⚠️ DISCLAIMER  
[Standard financial disclaimers and risk warnings]
```

**Emoji-Based Sentiment System:**
- **Bullish Indicators**: 📈 buy signals, growth, profits, positive momentum, upward trends
- **Bearish Indicators**: 📉 sell signals, decline, losses, negative sentiment, downward trends
- **Neutral Content**: general information, disclaimers, technical details with appropriate financial emojis

**Financial Emoji Integration:**
- 📈 Bullish/upward trends
- 📉 Bearish/downward trends  
- 💰 Money/profit analysis
- 💸 Losses/expenses
- 🏢 Company information
- 📊 Charts/data analysis
- 🎯 Key takeaways/important points
- ⚠️ Warnings/disclaimers

### Technical Implementation

**CLI Features:**
- Rich console formatting with emoji support
- Emoji-based sentiment indicators using financial emojis
- Enhanced typography with proper spacing and markdown rendering
- Automatic emoji rendering and financial context highlighting

**React Frontend Features:**
- Full markdown support with react-markdown
- Custom styled components for enhanced readability
- Emoji-based sentiment display consistent with CLI
- Real-time chat interface with loading states and error handling
- TypeScript for type safety and better development experience

**FastAPI Integration:**
- RESTful API bridge between CLI processing and React frontend
- CORS support for local development
- Error handling and input validation
- Health check endpoints for monitoring

---

## Enhanced Development Workflow

### Running the Application

- **Enhanced OpenAI CLI**: `uv run gpt5-openai-agents-sdk-polygon-mcp/src/main.py`
- **React Web Interface**: Start FastAPI server + React frontend (see setup section)
- **Original CLI interface**: `uv run market_parser_demo.py`
- **Original Web GUI interface**: `uv run chat_ui.py` (opens at <http://127.0.0.1:7860>)

### Testing with PyTest

The project includes comprehensive PyTest infrastructure for reliable testing:

#### Running Tests
```bash
# Install dev dependencies (includes pytest)
uv install --dev

# Run all tests
uv run pytest tests/

# Run specific test file
uv run pytest tests/test_file.py -v

# Run validation tests
uv run pytest tests/validate_pytest_setup.py -v

# Test discovery
uv run pytest --collect-only tests/
```

#### Test Infrastructure
- **Configuration**: `[tool.pytest.ini_options]` in pyproject.toml
- **Module Support**: All project modules (src/, stock_data_fsm/) accessible
- **Validation**: Use `tests/validate_pytest_setup.py` to verify setup

#### Enhanced Test Coverage
- **Run all tests**: `uv run pytest tests/` (comprehensive coverage with simplified architecture)
- **Run specific test**: `uv run pytest tests/test_file.py`
- **Run simplified architecture tests**: `uv run pytest tests/test_simplified_*.py`
- **Validate performance optimization**: `uv run python tests/validate_performance_optimization.py`

### Environment Management

- **Install dependencies**: `uv install`
- **Update dependencies**: `uv lock --upgrade`
- **Check environment**: `uv --version` and verify `.env` file exists

---

## How it Works (Enhanced Architecture)

- Loads your Polygon and OpenAI API keys from `.env`
- Starts the Polygon MCP server in the background
- Uses enhanced 5-state FSM for reliable workflow management
- Sends your natural language query to OpenAI `gpt-5-mini` via PydanticAI
- Returns dual-mode responses: structured JSON for buttons, conversational text for user messages
- Provides non-blocking error recovery for uninterrupted usage
- Monitors performance with advanced debug logging and cost optimization

### The Enhanced 5-State Workflow

1. **IDLE**: Ready for user input
2. **BUTTON_TRIGGERED**: User clicked an analysis button
3. **AI_PROCESSING**: Waiting for AI response with dual-mode processing
4. **RESPONSE_RECEIVED**: Display responses in single chat interface
5. **ERROR**: Non-blocking error state with immediate recovery and detailed logging

### Simplified Architecture Benefits

- **Single Chat Interface**: All interactions flow through one consolidated conversation
- **Dual Response Modes**: Button clicks show JSON data, user messages return natural language
- **Cost Optimization**: 35% reduction in processing costs through enhanced efficiency
- **Performance Enhancement**: 40% improvement in response processing speed
- **Comprehensive Monitoring**: Advanced logging with performance and cost tracking

---

## Migration from Previous Version

If you're upgrading from the previous version, see:
- `docs/SIMPLIFIED_ARCHITECTURE_GUIDE.md` for detailed migration steps
- `docs/PERFORMANCE_OPTIMIZATION_GUIDE.md` for cost optimization documentation
- `docs/reports/DUAL_MODE_RESPONSE_PROCESSING_REPORT.md` for technical implementation details
- `tests/validate_simplified_architecture.py` for architecture validation

---

## AI Team Structure

This project uses an optimized AI team configuration with:

- **Primary Architects**: `@backend-developer` leads simplified architecture and FSM design
- **Quality Assurance**: `@code-reviewer` mandatory for all changes with architecture integrity focus
- **Performance Optimization**: `@performance-optimizer` for cost reduction and efficiency enhancement
- **UI Enhancement**: `@frontend-developer` for single chat interface optimization
- **Documentation**: `@documentation-specialist` for comprehensive system guides
- **Deep Analysis**: `@code-archaeologist` for complex architecture decisions when needed

---

## Local Path

- /mnt/d/Github/market-parser-polygon-mcp

## License

This project is licensed under the [MIT License](LICENSE).